<!DOCTYPE html>
<html>
  <head>
    <title>RippleWeave</title>
    <meta utf='8'/>
    <meta name='author'       content='Xing Liu'/>
    <meta name='description'  content='2 spatial + 1 color dimension'/>
    <meta name='keywords'     content='graph,math,wallpaper'/>
    <link rel='shortcut icon' type='image/png' href='fav.png'/>
    <style>
html,body{
  margin:0;
}
 
*{
  box-sizing:border-box;
}
      
canvas{
  position:fixed;
  top:0;
  right:0;
  width:100vmin;
  height:100vmin;
  background:#fff;
  image-rendering:pixelated
}
      
main{
  position:fixed;
  overflow:scroll;
  display:block;
  left:0;
  width:calc(100vw - 100vmin);
  height:100vh;
  min-width:20rem;
  background:#111;
  font-family:Monospace,Monospace;
  color:#fff;
  padding:1rem 1rem 0 .6rem;
  text-align:center;
  text-align-last:center;
}

section>section{
  display:inline-flex;
}
      
::selection{
  background:#888;
  color:#fff;
}

:focus{
  outline:none;
}

.download{
  text-decoration:none;
}

section>*{
  width:100%;
	margin:.2rem 0;
}

section>section>*{
  padding:.2rem;
  font-size:inherit;
  font-family:inherit;
  color:inherit;
  height:2rem;
  margin:0 .4rem;
  border-width:.2rem;
  border-style:solid;
}
section>section>*+*{
  margin-left:0;
}

h2{
	font-size:1rem;
	font-weight:normal;
	margin-top:1rem;
  padding:.2rem;
  color:#888;
	border:solid .2rem #222;
}

label{
	flex:0 1 8rem;
  background:#222;
  border-color:#000;
}
input,select,.download{
	flex:1 1 8rem;
  background:#000;
  border-color:#222;
}
select,.download{
  cursor:pointer;
}
      
input[type=range]{
  -webkit-appearance:none;
  background:#000;
  cursor:ew-resize;
  background-size:calc(100% - .5rem) calc(100% - .5rem);
  background-position:center;
  background-repeat:no-repeat;
}
input:hover:not(:focus),.download:hover:not(:focus){
  background:#111;
  border-color:#333
}
input:focus,.download:focus{
  border-color:#444
}
input:focus:hover,.download:focus:hover{
  border-color:#555
}
      
input[name=hue-offset][type=range]{
  --sat:100%;
  --lum:10%;
  background-image:linear-gradient(
    90deg,
    hsl(0deg,var(--sat),var(--lum)),
    hsl(120deg,var(--sat),var(--lum)),
    hsl(240deg,var(--sat),var(--lum)),
    hsl(360deg,var(--sat),var(--lum))
  );
}
input[name=sat-offset][type=range]{
  background-image:linear-gradient(
    90deg,
    hsl(0deg,0%,10%),
    hsl(120deg,33.3%,12%),
    hsl(240deg,66.7%,14%),
    hsl(360deg,100%,16%)
  );
}
input[name=lum-offset][type=range]{
  background-image:linear-gradient(90deg,#000,#222);
}

            
@media(prefers-color-scheme:no-preference){
  main{
    filter:invert(1)
  }
  input[name=lum-offset][type=range]{
    background-image:linear-gradient(90deg,#222,#000);
  }
}

#custom-function-option{
	display:none;
}
    </style>
  </head>
  <body>
    <canvas></canvas>
    <main>
      
      <h1>RippleWeave</h1>
      
      <section>
	      <h2>A function grapher by Xing</h2>
      	<section>
	      	<label>Presets</label>
          <select name='presets'>
            <option value='0' selected>Original</option>
            <option value='1'>Extra Crispy</option>
            <option value='2'>Glitcher</option>
            <option value='3'>Nubbin</option>
            <option value='4'>Atanto</option>
            <option value='5'>Flare</option>
            <option value='6'>Night</option>
          </select>
         </section>
    	</section>
      <section>
      	<h2>Functions</h2>
        <section>
          <label>f(x,y)</label>
	        <input name='function-1' type='text' value='|sin(x^2)+cos(y^2)|/2'/>
        </section>
        <section>
          <label>g(x,y)</label>
	        <input name='function-2' type='text' value='0'/>
        </section>
        <section>
          <label>h(x,y)</label>
	        <input name='function-3' type='text' value='0'/>
        </section>
      </section>
      <section>
      	<h2>Channels</h2>
      	<section>
      		<label>Mode</label>
      		<select>
      			<option value='hsl'>Hue/Saturation/Luminosity</option>
      			<option value='rgb'>Red/Green/Blue</option>
      		</select>
      	</section>
        <section>
        	<label>Hue</label>
	        <input name='channel-1' type='text' value='f(x,y)'/>
        </section>
        <section>
        	<label>Saturation</label>
	        <input name='channel-2' type='text' value='-f(x,y)'/>
        </section>
        <section>
        	<label>Luminosity</label>
	        <input name='channel-3' type='text' value='50'/>
        </section>
      </section>
      <section>
      	<h2>Render</h2>
        <section>
          <label>Download</label>
          <a class='download image' id='png' download='ripple-weave.png' href='#'>PNG</a>
          <a class='download image' id='jpg' download='ripple-weave.jpg' href='#'>JPG</a>
        </section>
        <section>
          <label>Resolution</label>
          <input name='resolution' type='number' value='32'/>
          <input name='resolution' type='range'  value='32' min='1' max='1024'/>
        </section>
      </section>
    </main>
  <script>
clamp = ( min , val , max ) => Math.max ( min, Math.min ( val , max ) )
format_fn = ( fn ) => fn.replace(/(x|y)(x|y)/g,'$1*$2')
												.replace(/(x|y)(x|y)/g,'$1*$2')
												.replace(/(abs|acos|acosh|asin|asinh|atan|atanh|atan2|cbrt|ceil|clz32|cos|cosh|exp|expm1|floor|fround|hypot|imul|log|log1p|log10|log2|max|min|pow|random|round|sign|sin|sinh|sqrt|tan|tanh|trunc|E|LN2|LN10|LOG2E|LOG10E|PI|SQRT1_2|SQRT2)/g,'Math.$1')
												.replace(/\^/g,'**')
												.replace(/\|/,'Math.abs(')
												.replace(/\|/,')')
let canvas_size = 32 ,
		mode = 'hsl',
    fn_f	= format('|sin(x^2)+cos(y^2)|/2'),
    fn_g = fn_h = 0,
    ch_1 = 'f(x,y)',
    ch_2 = '100',
    ch_3 = 'f(y,x)'
const doc     = document ,
      canvas  = doc.getElementsByTagName('canvas')[0] ,
      ctx     = canvas.getContext('2d') ,
      inputs    = Array.from(doc.querySelectorAll('input,select')) ,
      downloads = Array.from(doc.getElementsByClassName('download')) ,
      norm360 = ( value ) => {
        return Math.abs ( value % 360 )
      },
      handler = ( event ) => {
        let name  = event.target.name,
            value = event.target.value,
            tag   = event.target.tagName
        if ( value ) {
          switch ( name ) {
            case 'resolution':
              canvas_size = value = Math.max ( value , 1 )
              break
            case 'resolution-function-options':
              canvas.style.imageRendering = value
              break
            case 'hue-function-options':
              hue_function_option = value
              break
            case 'sat-function-options':
              sat_function_option = value
              break
            case 'lum-function-options':
              lum_function_option = value
              break
            case 'zoom':
              zoom = value = - Math.abs(value)
              break
            case 'graph-x-offset':
              graph_x_offset = value
              break
            case 'graph-y-offset':
              graph_y_offset = value
              break
            case 'hue-offset':
              hue_offset = value = norm360 ( value )
              break
            case 'sat-offset':
              sat_offset = value = Math.clamp ( 0 , value , 100 )
              break
            case 'lum-offset':
              lum_offset = value = Math.clamp ( 0 , value , 100 )
              break
            case 'f':
            	if ( value === 'custom' || tag === 'INPUT' ) {
            		doc.getElementById('custom-function-option').style.display='flex'
            	} else {
            		doc.getElementById('custom-function-option').style.display='none'
            	}
            	if ( value !== 'custom' ) {
            		f_input_string = value
	              f_formatted_string = f_input_string
	            	
            	}
              break
          }
          if ( ( name!=='f' && ( tag === 'SELECT' || tag === 'INPUT' ) ) || ( name === 'f' && tag ==='SELECT' && value !=='custom' ) ) {
            Array.from(
              doc.getElementsByName( name )
            ).forEach( ( input ) => {
              input.value = value
            })
          }
        }
      } ,
      f = ( x , y ) => {
      	return eval ( f_formatted_string )
      } ,
      draw = () => {
        canvas.width = canvas.height = canvas_size
        for ( let canvas_x = 0 ; canvas_x < canvas_size ; canvas_x ++ ) {
	        for ( let canvas_y = 0 ; canvas_y < canvas_size ; canvas_y ++ ) {
          	graph_x = canvas_x / canvas_size * graph_zoom + graph_translate_x
      			graph_y = canvas_y / canvas_size * graph_zoom + graph_translate_y
            let functions = [ 0,
                        f ( graph_x , graph_y ),
                        f ( graph_y , graph_x ),
                      ]
            functions[3] = 1 - functions[1]
            functions[4] = 1 - functions[2]
            ctx.fillStyle = `
              hsl(
                ${ functions[hue_function_option]*360 + hue_offset },
                ${ functions[sat_function_option]*100 + sat_offset }%,
                ${ functions[lum_function_option_option]*100 + lum_offset }%
              )
            `
            ctx.fillRect( x , y , 1 , 1 )
          }
        }
      }
inputs.forEach((element)=>{
  element.addEventListener('input',handler)
  element.addEventListener('change',draw)
})
downloads.forEach((element)=>{
  element.addEventListener('click',()=>{
  	element.download=f_input_string.replace(/\|/g,'।').replace(/\//g,'÷').replace(/\*/g,'×').replace(/\-/g,'−')+'.png'
    element.href = canvas.toDataURL(`img/${element.id}`).replace(/^data:image\/[^;]*/, 'data:application/octet-stream')
  } , false)
})
draw()
    </script>
  </body>
</html>